<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HUAT AH</title>
  <style>
	body {
	  background-image: url("huat.jpg");
      background-color: #E5250C;
	  background-repeat: no-repeat;
	  background-position: 50% 10%;
	  background-size: auto;
	}
	</style>
</head>

<body class="vsc-initialized" cz-shortcut-listen="true">
<script>

var context;
var gainNode;
var yamBuffer = null;
var sengBuffer = null;
var ymymymBuffer = null;
var yamSource = null;
var sengSource = null;
var ymymymSource = null;
var yamming;
var ymymyming;
var yamcount = 0;
var pitch = 1.0;
var sleepcount;
var hiddendiv;

window.addEventListener('load', init, false);

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function init() {
	try {
		// Fix up for prefixing
		window.AudioContext = window.AudioContext || window.webkitAudioContext;
		context = new AudioContext();
		gainNode = context.createGain();
		gainNode.connect(context.destination);
	} catch (e) {
		alert('Web Audio API is not supported in this browser');
	}

	loadyam("yam.mp3");
	loadseng("seng.mp3");
	loadymymym("ymymym.mp3");

    //wait up to 10 seconds for the mp3's to load
    sleepcount=0;
	while (sleepcount<100)
	{
		await sleep(100);
		sleepcount=sleepcount+1;
		if ((yamBuffer!=null)&&(sengBuffer!=null)&&(ymymymBuffer!=null)) sleepcount=100;
	}

	var el = document.getElementById("yamsengpad");
	el.addEventListener("touchstart", handleStart, false);
	el.addEventListener("touchend", handleEnd, false);
	el.addEventListener("touchcancel", handleCancel, false);
	el.addEventListener("touchmove", handleMove, false);
	el.addEventListener("touchforcechange", handleForceChange, false);
    el.style.display=""; //unhide yamsengpad only after mp3s loaded
	yamming = 0;
	ymymyming = 0;
}

function loadyam(url) {
	var request = new XMLHttpRequest();
	request.open('GET', url, true);
	request.responseType = 'arraybuffer';

	// Decode asynchronously
	request.onload = function() {
		context.decodeAudioData(request.response, function(buffer) {
			yamBuffer = buffer;
		}, function(error) {
			console.error('decodeAudioData error', error);
		});
	}
	request.send();
}

function loadseng(url) {
	var request = new XMLHttpRequest();
	request.open('GET', url, true);
	request.responseType = 'arraybuffer';

	// Decode asynchronously
	request.onload = function() {
		context.decodeAudioData(request.response, function(buffer) {
			sengBuffer = buffer;
		}, function(error) {
			console.error('decodeAudioData error', error);
		});
	}
	request.send();
}

function loadymymym(url) {
	var request = new XMLHttpRequest();
	request.open('GET', url, true);
	request.responseType = 'arraybuffer';

	// Decode asynchronously
	request.onload = function() {
		context.decodeAudioData(request.response, function(buffer) {
			ymymymBuffer = buffer;
		}, function(error) {
			console.error('decodeAudioData error', error);
		});
	}
	request.send();
}

function playSound(buffer,pitch) {
	var source = context.createBufferSource(); // creates a sound source
	source.buffer = buffer; // tell the source which sound to play
	source.playbackRate.value=pitch;
	source.connect(gainNode);
	gainNode.gain.value = 1.0;
	if (context.state=="suspended" || context.state=="interrupted") context.resume();
	source.start(0); // play the source now
	return source;
}

function stopSound(source){
	if ((source!=null)&&(source.playbackState==source.PLAYING_STATE))
		source.stop(0);
}

function handleStart(evt) {
	evt.preventDefault();

	if (yamming == 0) {
		yamcount = yamcount + 1;
		pitch=1.0;
		if (yamcount > 5) pitch = 0.875 + (Math.random() / 4.0);

		unmute2(context);
		stopSound(sengSource);
		stopSound(yamSource);
		yamSource = playSound(yamBuffer,pitch);
		yamming = 1;
		
		//reset ymymyming just to play safe
		if ((evt.touches.length < 2) && (ymymyming == 1)) {
			stopSound(ymymymSource);
			ymymyming = 0;
		}
	}

	if ((evt.touches.length > 1) && (ymymyming == 0)) //more than one finger ymymym
	{
		var ymymympitch=1.0;
		if (yamcount > 5) ymymympitch= 0.875 + (Math.random() / 4.0);
		ymymymSource = playSound(ymymymBuffer,ymymympitch);
		ymymyming = 1;
	}

}

async function handleEnd(evt) {
	evt.preventDefault();

	if ((evt.touches.length < 2) && (ymymyming == 1)) {
		stopSound(ymymymSource);
		ymymyming = 0;
	}

	if (evt.touches.length == 0) //all fingers lifted off
	{
		yamming = 0;
		if (yamming==0 && gainNode!=null) 
			{gainNode.gain.value = 0.50;await sleep(100);}
		if (yamming==0 && gainNode!=null) 
			{gainNode.gain.value = 0.25;await sleep(100);}
		if (yamming==0 && gainNode!=null) 
			{gainNode.gain.value = 0;await sleep(100);}

		if (yamming==0) stopSound(yamSource);
		if (yamming==0 && gainNode!=null) gainNode.gain.value = 1.0;
		if (yamming==0) sengSource = playSound(sengBuffer,pitch);
	}
}

function handleCancel(evt) {
	evt.preventDefault();
}

function handleMove(evt) {
	evt.preventDefault();
}

function handleForceChange(evt) {
	evt.preventDefault();
}

function unmute2(context) {
	// a hack to enable sound even when on silent mode on iPhone
	var ua = navigator.userAgent.toLowerCase();
	var isiphone = ua.indexOf("iphone") >= 0 && ua.indexOf("like iphone") < 0;
	var isipad = ua.indexOf("ipad") >= 0 && ua.indexOf("like ipad") < 0;
	var isipod = ua.indexOf("ipod") >= 0 && ua.indexOf("like ipod") < 0;
	if (isiphone || isipad || isipod) {
		if (hiddendiv==null) {
			hiddendiv = document.createElement("div");
			hiddendiv.innerHTML = "<audio x-webkit-airplay='deny'></audio>";
			var hiddentag = hiddendiv.children.item(0);
			hiddentag.controls = false;
			hiddentag.disableRemotePlayback = true;
			hiddentag.preload = "auto";
			// 0.01 seconds of silence
			hiddentag.src = "data:audio/mpeg;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA//////////////////////////////////////////////////////////////////8AAABhTEFNRTMuMTAwA8MAAAAAAAAAABQgJAUHQQAB9AAAAnGMHkkIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sQxAADgnABGiAAQBCqgCRMAAgEAH///////////////7+n/9FTuQsQH//////2NG0jWUGlio5gLQTOtIoeR2WX////X4s9Atb/JRVCbBUpeRUq//////////////////9RUi0f2jn/+xDECgPCjAEQAABN4AAANIAAAAQVTEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVQ==";
			hiddentag.loop = true;
			hiddentag.load();
		}
		hiddendiv.children.item(0).play();
	}
}

</script>

<table id="yamsengpad" style="height: 75%; width: 80%; position: absolute; top: 10%; left: 10%; border: none;">
     <tbody><tr>
        <td>
          <div style="font-family:Helvetica,Arial,sans-serif;font-size:13vw;text-align:center;color: white">
HUAT<br>AH
</div>
        </td>
    </tr>

</tbody></table>

</body></html>